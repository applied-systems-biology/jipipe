#!/bin/bash

unset XDG_DATA_DIRS
JRE_DOWNLOAD_URL="https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-11.0.8%2B10/OpenJDK11U-jre_x64_linux_hotspot_11.0.8_10.tar.gz"
JRE_DOWNLOAD_NAME="jdk-11.0.8+10-jre"

# Look for a Java version to run 
if type -p java; then
    echo "Found java executable in PATH"
    JRE_BINARY=java
elif [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]];  then
    echo "Found java executable in JAVA_HOME"
    JRE_BINARY="$JAVA_HOME/bin/java"
else
    echo "No Java was found"
fi

if [[ "$JRE_BINARY" ]]; then
    version=$("$JRE_BINARY" -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d. -f2)
    echo "Found Java version $version"
    if [[ "$version" -ge "8" ]]; then
        echo "Java version is sufficient. Running installer using this version."
    else         
        echo "Java version is insufficient. Downloading AdoptOpenJDK JRE now."
        unset JRE_BINARY
    fi
fi

if [[ ! "$JRE_BINARY" ]]; then
    JRE_TARGET_DIR=$(mktemp -d -t jipipe-installer-jre-XXXXXXXXXX)
    xterm -xrm 'XTerm.vt100.allowTitleOps: false' -T "Bootstrapping Java ... please wait" -e "cd $JRE_TARGET_DIR && wget $JRE_DOWNLOAD_URL -O $JRE_TARGET_DIR/$JRE_DOWNLOAD_NAME.tar.gz && tar -xvf $JRE_DOWNLOAD_NAME.tar.gz"
    JRE_BINARY=$JRE_TARGET_DIR/$JRE_DOWNLOAD_NAME/bin/java
fi

cd ${APP_ROOT}/usr/share/jipipe-installer
exec "$JRE_BINARY" -jar ${APP_ROOT}/usr/share/jipipe-installer/jipipe-installer-linux.jar "$@"
